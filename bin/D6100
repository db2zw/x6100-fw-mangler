#!/bin/sh
# (C) 2023 Joerg Jungermann, GPLv2 see LICENSE
set -e

PREFIX="${0%/bin/${0##*/}}"
DEP_DIR="$PREFIX/.deps"
BUILT_FLAG="$DEP_DIR/img-mangler.built"
IMAGE=x6100:img-mangler
WORKDIR=/src

[ -f "$BUILT_FLAG" ] || \
  make img-mangler

OPTS=
OPTS="$OPTS --rm"

if [ "$#" = 0 ]; then
  OPTS="$OPTS -it"
fi

while [ -n "$1" ]; do # eval until the first unknown argument
  case "$1" in
    -it | -ti | -i | -t )
      OPTS="$OPTS $1"
      shift
      ;;
    -p )
      OPTS="$OPTS --privileged"
      shift
      ;;
    -e )
      OPTS="$OPTS -e '$2'"
      shift
      shift
      ;;
    --pid-host | -ph )
      shift
      OPTS="$OPTS --pid host"
      ;;
    --image )
      IMAGE="$2"
      shift
      shift
      ;;
    -v )
      OPTS="$OPTS -v $2"
      shift
      shift
      ;;
    -w )
      WORKDIR="$2"
      shift
      shift
      ;;
    * )
      break
      ;;
  esac
done

eval "docker run --rm -v $PWD:/src -w '$WORKDIR' -e 'OWNER=$(id -u)' -e 'GROUP=$(id -g)' $OPTS '$IMAGE' \"\$@\""
